<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/hero.me/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/hero.me/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/hero.me/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/hero.me/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/hero.me/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/hero.me/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/hero.me/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="vue,react,webpack,小程序,react-native"><meta name="description" content="前端开发文艺工作者"><meta name="keywords" content="vue,react,webpack,小程序,react,native"><meta property="og:type" content="website"><meta property="og:title" content="小南のblog"><meta property="og:url" content="https://wangnan41.github.io/index.html"><meta property="og:site_name" content="小南のblog"><meta property="og:description" content="前端开发文艺工作者"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="小南のblog"><meta name="twitter:description" content="前端开发文艺工作者"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/hero.me/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://wangnan41.github.io/"><title>小南のblog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/hero.me/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">小南のblog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle" style="display:inline-block;margin:0;padding:0">桃李春风一杯酒，江湖夜雨十年灯</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-fe"><a href="/hero.me/categories/fe" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 前端笔记</a></li><li class="menu-item menu-item-translation"><a href="/hero.me/categories/translation" rel="section"><i class="menu-item-icon fa fa-fw fa-language"></i><br> 译文</a></li><li class="menu-item menu-item-travel"><a href="/hero.me/categories/travel" rel="section"><i class="menu-item-icon fa fa-fw fa-plane"></i><br> 旅行</a></li><li class="menu-item menu-item-book"><a href="/hero.me/categories/book" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br> 读书笔记</a></li><li class="menu-item menu-item-archives"><a href="/hero.me/categories/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-about"><a href="/hero.me/categories/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wangnan41.github.io/hero.me/2019/06/26/为什么在一些情况下WebAssembly比JavaScript更具有优势/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="小南"><meta itemprop="description" content><meta itemprop="image" content="/hero.me/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小南のblog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/hero.me/2019/06/26/为什么在一些情况下WebAssembly比JavaScript更具有优势/" itemprop="url">为什么在一些情况下WebAssembly比JavaScript更具有优势</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-26T14:07:38+08:00">2019-06-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/hero.me/categories/translation/" itemprop="url" rel="index"><span itemprop="name">translation</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p>作者:Alexander Zlatkov | 译：汪楠<br>原文地址：[<a href="https://blog.sessionstack.com/how-javascript-works-a-comparison-with-webassembly-why-in-certain-cases-its-better-to-use-it-d80945172d79/]" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-a-comparison-with-webassembly-why-in-certain-cases-its-better-to-use-it-d80945172d79/]</a></p><p>本文是探究<code>JavaScript</code>工作原理和构建组件文章的第六篇。在鉴定和描述核心内容过程中，我们同时分享了在开发<code>SessionStack</code>时候的一些经验。<code>SessionStack</code>其实是一款帮助用户实时查看和重现其Web应用缺陷的轻量级<code>JavaScript</code>应用程序。它拥有强大的功能和不错的性能表现。</p><p>如果你错过了之前的文章，可以点击下面的链接：</p><ul><li>An overview of the engine, the runtime, and the call stack</li><li>Inside Google’s V8 engine + 5 tips on how to write optimized code</li><li>Memory management + how to handle 4 common memory leaks</li><li>The event loop and the rise of Async programming + 5 ways to better coding with async/await</li><li>Deep dive into WebSockets and HTTP/2 with SSE + how to pick the right path</li></ul><p>这次我们将拆分<code>webAssembly</code>来阐述其工作原理。重点则是对比<code>JavaScript</code>，分析它们在一些性能方面上的差异：加载时间，执行速度，垃圾回收，内存占用，平台API，调试，多线程和可移植性。</p><p>我们开发web应用方式正处于变革的边缘，虽然现在来看还为时尚早，可是我们对于web应用的思考正在不断的发生改变。</p><h1 id="首先，让我们看看WebAssembly是什么"><a href="#首先，让我们看看WebAssembly是什么" class="headerlink" title="首先，让我们看看WebAssembly是什么"></a>首先，让我们看看WebAssembly是什么</h1><p><code>WebAssembly</code>（又名wasm）是一个运行在网络浏览器中的高效的、低级别的字节码。<code>WASM</code>使得你可以使用JavaScript以外的语言（C,C++,Rust 等），用它们编写代码，然后提前编译成<code>WebAssembly</code>。</p><p>这所带来的好处的就是可以非常快的加载和运行web程序。</p><h1 id="加载时间"><a href="#加载时间" class="headerlink" title="加载时间"></a>加载时间</h1><p>为了去加载JavaScript，浏览器不得不去加载所有带“.js”后缀的文本文件。</p><p><code>WebAssembly</code>在浏览器中加载更快，因为它只需要通过互联网传输已经编译完的<code>wasm</code>文件。 并且<code>wasm</code>是一个低级别的，非常紧凑的二进制格式的类汇编语言。</p><h1 id="执行速度"><a href="#执行速度" class="headerlink" title="执行速度"></a>执行速度</h1><p>目前<code>Wasm</code>执行速度只比原生代码慢20%。这无疑是一个令人惊讶的结果。因为它是一种被编译在沙箱环境中的格式，并且运行在诸多限制条件下或者苛刻的条件下，以确保其安全性。与本地运行的代码相比慢了一些。重点是，可以预见它在未来将会更快。</p><p>更具有优势的是，它与浏览器无关，所有浏览器引擎都增加了对<code>WebAssembly</code>的支持并且目前执行的时间也很类似。</p><p>为了理解<code>WebAssembly</code>执行速度相比较<code>Javascript</code>有多快，你应该先阅读我们关于<code>Javascript</code>引擎是如何工作的那篇文章。</p><p>让我们从下图直观看一下Javascript运行在V8引擎中发生什么事。</p> <img src="http://img11.360buyimg.com/uba/jfs/t16804/209/1074245115/32369/406c0c76/5abb0509Ne7c83bf5.png" width="250"><p>在图的左边，我们有一些JavaScript源码，包含了一些Javascript函数。首页需要被解析，将字符串转变为标记符号，然后生成抽象语法树（AST）。AST是你的JavaScrip代码在内存中逻辑表示。一旦生成AST表示，V8引擎可直接将其转成机器码。你基本只能按照这个树，生成机器码，然后执行你的函数。这样根本没有尝试使得它执行的更快。</p><p>现在，看一下V8管道是如何做的：</p> <img src="http://img14.360buyimg.com/uba/jfs/t15856/279/2678048376/22864/ab67d883/5abb0509Ne6cd615e.png" width="250"><p>此刻我们有了<code>TurboFan</code>，一个V8优化编译器。当你的JavaScript应用正在运行，很多代码都执行在V8中。<code>TurboFan</code>可以监控某些代码是否执行过慢，是否存在瓶颈和关键点需要优化。它将推送他们到后台交给已优化的JIT处理，它是专门为优化那些耗CPU内存的代码函数准备。</p><p>它解决了这个问题，但是也产生了另外的问题，在分析代码并且决定优化那些内容也同样消耗CPU。反过来说，这将意味需要消耗更多的电池能量，在移动设备上就更明显了。</p><p>很明显，<code>wasm</code>并不需要这么多操作，它可以被插入到工作流中像下图这样。</p> <img src="http://img11.360buyimg.com/uba/jfs/t16717/258/1119106469/27472/1db72da3/5abb0509N51a8f2fc.png" width="250"><p><code>Wasm</code>已经在编译阶段进行了优化。最重要的是解析也不需要了。你已经有一份优化完的二进制代码可以直接输入到后台生成机器码。所有优化工作都已经在前台编译器中完成。</p><p>这样<code>wasm</code>可以在运行时候跳过工作流中的一些步骤，使得执行更加高效。</p><h1 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h1><img src="http://img10.360buyimg.com/uba/jfs/t17038/205/1037656294/55091/faf0b9e1/5abb0509Nb40723f1.png" width="250"><p>例如，被编译成<code>WebAssembly</code>的C++程序在内存中是连续的，没有“漏洞”的。<code>Wasm</code>的一大特征就是使得执行堆栈和线性内存相分离，这样有助于提高代码安全性。在C++编程中，你有一个堆栈，从底部分配栈，从顶部堆栈。这样，也许你也可以利用一个指针在堆栈内存中查找到一些你不应该访问到的变量。</p><p>这是很多恶意软件惯用的手段。</p><p><code>WebAssembly</code>采用完全不同的模型。执行堆栈和<code>WebAssembly</code>程序本身是分离的，所以你根本没机会在内存里改变它和改变变量之类的。而且，这些函数使用整数偏移而非指针。函数指向一个间接函数表。使用这些计算数字直接跳到模块中对应的函数中。它是以这种方式并排的加载多个<code>wasm</code>模块，并且不采用指针索引，功能同样也能正常运转。</p><p>想要更多关于内存模型信息和如何在JavaScript中管理，你可以点击post on topic这篇文章。</p><h1 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h1><p>你肯定对JavaScript的内存管理是用垃圾回收器集中处理的有所了解。<code>WebAssembly</code>的情况略有不同。它支持编写代码管理内存。你可以将自己写的<code>GC</code>和<code>wasm</code>模块打包在一起。当然这会是一个很复杂的任务。</p><p>目前，<code>WebAssembly</code>是围绕C++和RUST用例设计的。因为<code>wasm</code>是非常低级别的，它使得编程语言只是位于汇编语言之上一小步，因此非常容易编译它。C 能够使用标准的<code>malloc</code>，C++使用智能指针，Rust 则采用完全不同的模式（完全不同的领域）。这三门语言都不使用GC，它们不需要在运行时候跟踪内存的复杂的东西。<code>WebAssembly</code>很显然非常适合它们。</p><p>另外，这些语言并不是100%为复杂的JavaScript事物而设计的，例如更改DOM。采用C++来编写完整的HTML应用是有些愚笨的。因为C++并不是为它而设计的一门语言。在大多数情况下，工程师们编写C++或者Rust 主要是为了<code>WebGL</code>或者高度优化的库（例如：需要大量数学计算）。</p><p>在未来，<code>WebAssembly</code>会支持那些不带<code>GC</code>的语言。</p><h1 id="平台API接入"><a href="#平台API接入" class="headerlink" title="平台API接入"></a>平台API接入</h1><p>依靠在运行时才执行JavaScript，JavaScript应用程序可以接入访问平台提供的特定的API。例如，你在浏览器中执行JavaScript代码，你会有一组Web API可供Web应用程序调用来控制web浏览器/设备功能像DOM、CSSOM、WebGL、IndexedDB、Web Audio API等。</p><p>然而，<code>WebAssembly</code>模块还不支持任何平台的API。任何API都是由JavaScript来调用。如果你想在<code>WebAssembly</code>模块中调用平台特定的API，只能通过JavaScript调用才行。</p><p>举个例子：如果你想使用<code>console.log</code>，你不得不使用JavaScript代替C++的代码。而调用JavaScript代码则会导致运行成本的增加。<br>这不会一直都是这样的，规范提出了在未来将为平台API提供<code>wasm</code>，使得你发布跟JavaScript没有任何关系的应用。</p><h1 id="source-maps"><a href="#source-maps" class="headerlink" title="source maps"></a>source maps</h1><p>当你压缩JavaScript代码后，你需要一个可行的方法来调试它。这就是<code>source maps</code>用武之地。从基础上来讲，<code>source maps</code>是一种将组合和压缩文件与之前未操作状态映射的方法。当你构建生产环境代码时，压缩合并了你的JavaScript文件，也同时生产了一个<code>source maps</code>文件，它包含了所有源文件的信息。当你在生成的JavaScript中查询确定行和列的代码时候，在<code>source maps</code>中查找返回对应的原始位置。</p><p><code>WebAssembly</code>目前不支持<code>source maps</code>，还有相关的规范，但相信很快会有。<br>当你在C++中设置断点，你将会在C++ 代码中看到中断而不是在<code>WebAssembly</code>中。至少，这是我们所期望的目标。</p><h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><p>JavaScript虽然只能运行在单线程上。不过有方法利用事件循环和异步编程像在此篇文章详细描述的内容这样来实现多线程。<br>JavaScript也可以使用<code>Web Workers</code>，他们有一个非常具体的例子—任何CPU高速的运转都会阻塞UI主线程，可以通过Web Worker下线线程解决。可是，<code>Web Workers</code>并不能直接操作DOM。</p><p><code>WebAssembly</code>并不支持多线程，但是很快应该可以支持这个。Wasm将来与本地线程非常类似（比如像C++ 线程）。拥有真实的线程在浏览器中会创造出很多新的机会。当然，同样也有可能打开了滥用线程的大门。</p><h1 id="可移植性"><a href="#可移植性" class="headerlink" title="可移植性"></a>可移植性</h1><p>如今，JavaScript可以在任何地方运行，从浏览器到服务端甚至嵌入式系统中。<br><code>WebAssembly</code>从设计上就保证了安全性和可移植性，就像JavaScript一样，它将运行在任何支持wasm的环境中（任何浏览器）。<br><code>WebAssembly</code>与Java关于小程序的早期想要获取的目标是一致的。</p><h1 id="在什么场景下使用WebAssembly更优于JavaScript呢？"><a href="#在什么场景下使用WebAssembly更优于JavaScript呢？" class="headerlink" title="在什么场景下使用WebAssembly更优于JavaScript呢？"></a>在什么场景下使用<code>WebAssembly</code>更优于<code>JavaScript</code>呢？</h1><p>在<code>WebAssembly</code>第一个版本中，主要关注于需要大量CPU计算（比如处理数学问题）。他想到能被大量使用的场景就是游戏—有非常多的像素点需要计算。你可以用C++或者Rust 编写你熟悉的<code>OpenGL</code>代码，并且将其编译成<code>wasm</code>。然后它就可以在浏览器中跑起来。</p><p>可以点击这个看一下（在<code>firefox</code>中运行）<br><a href="http://s3.amazonaws.com/mozilla-games/tmp/2017-02-21-SunTemple/SunTemple.html。它是运行在虚幻引擎中。" target="_blank" rel="noopener">http://s3.amazonaws.com/mozilla-games/tmp/2017-02-21-SunTemple/SunTemple.html。它是运行在虚幻引擎中。</a></p><p>另外比较有意义的事是使用<code>WebAssembly</code>（性能方面）实现一些处理CPU高密集工作的库。例如，某些图像处理。<br>在前面提到，<code>wasm</code>大多数处理提早在编译环节已经完成，因此在移动设备上可以减少其运行时候的所需要的电池能耗（很大程度上取决于引擎）。</p><p>在未来，你可以使用<code>WASM</code>库实现功能，即使你并没有编写代码和编译他们。你可以在<code>NPM</code>中找到对应的项目和其使用方法。<br>对于DOM操作和平台API的使用，使用JavaScript是非常合适，因为它并不会增加额外的开销，并且有本地API可以供使用。</p><p>在<code>SessionStack</code>中，我们不断的挑战JavaScript性能的边界，为了能够编写高度优化且高效的代码。我们提供的解决方案提供非凡的性能，所以不会降低客户本身的app的性能。将SessionStack集成到用户生产的Web应用或者网站后，它会开始记录任何内容：DOM的改变，用户交互，JavaScript异常，堆栈跟踪，失败的网络请求和调试数据。所有这些都将在生产环境中进行，但是不会影响产品的UX和性能。我们需要大量的优化代码和尽可能的异步操作。</p><p>不单单只有这个库而已！当你重放用户的会话在<code>SessionStack</code>中，我们必须重现当时出问题的所有现场，并且必须重构整个状态，允许你可以在会话的时间线上来回切换。为了做到这一点，我们大量使用JavaScript提供的异步方案，因为目前还是缺少可以替代的办法。</p><p>借助<code>WebAssembly</code>，我们可以将一些繁琐的处理和渲染转交给更合适的编程语言，并且将数据收集和DOM操作留给JavaScript来处理。<br>如果你想尝试使用一个<code>SessionStack</code>，你可以在开始时候免费使用。每个月计划将有1000个免费会话提供。</p> <img src="http://img20.360buyimg.com/uba/jfs/t18622/253/1086788209/116877/fa01d6cf/5abb050aNf5263976.png" width="250"><p>视频资源：<br><a href="https://www.youtube.com/watch?v=6v4E6oksar0" target="_blank" rel="noopener">https://www.youtube.com/watch?v=6v4E6oksar0</a><br><a href="https://www.youtube.com/watch?v=6Y3W94_8scw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=6Y3W94_8scw</a></p><h1 id="扩展阅读："><a href="#扩展阅读：" class="headerlink" title="扩展阅读："></a>扩展阅读：</h1><p>SessionStack:<a href="https://www.sessionstack.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_content=Post-6-webassembly-intro" target="_blank" rel="noopener">https://www.sessionstack.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_content=Post-6-webassembly-intro</a></p><p>An overview of the engine, the runtime, and the call stack:<a href="https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf?source=collection_home---2------1----------------" target="_blank" rel="noopener">https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf?source=collection_home---2------1----------------</a></p><p>Inside Google’s V8 engine + 5 tips on how to write optimized code:<a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e?source=collection_home---2------2----------------" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e?source=collection_home---2------2----------------</a></p><p>Memory management + how to handle 4 common memory leaks:<a href="https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec?source=collection_home---2------0----------------" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec?source=collection_home---2------0----------------</a></p><p>The event loop and the rise of Async programming + 5 ways to better coding with async/await:<a href="https://blog.sessionstack.com/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with-2f077c4438b5</a></p><p>Deep dive into WebSockets and HTTP/2 with SSE + how to pick the right path:<a href="https://blog.sessionstack.com/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path-584e6b8e3bf7?source=collection_home---4------0----------------" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-deep-dive-into-websockets-and-http-2-with-sse-how-to-pick-the-right-path-584e6b8e3bf7?source=collection_home---4------0----------------</a></p><p>our article on how the JavaScript engine:<a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e?source=---------3----------------" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e?source=---------3----------------</a></p><p>AST:<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Abstract_syntax_tree</a></p><p>post on the topic:<a href="https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec" target="_blank" rel="noopener">https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec</a></p><p>Web APIs:<a href="https://developer.mozilla.org/en-US/docs/Web/API" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API</a></p><p>DOM:<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model</a></p><p>CSSOM:<a href="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model</a></p><p>WebGL:<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API</a></p><p>IndexedDB:<a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API</a></p><p>Web Audio API:<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wangnan41.github.io/hero.me/2019/06/26/Gaea：简易好用的Vue技术栈单页面构建工具/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="小南"><meta itemprop="description" content><meta itemprop="image" content="/hero.me/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小南のblog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> <a class="post-title-link" href="/hero.me/2019/06/26/Gaea：简易好用的Vue技术栈单页面构建工具/" itemprop="url">Gaea：简易好用的Vue技术栈单页面构建工具</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-26T11:39:58+08:00">2019-06-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/hero.me/categories/fe/" itemprop="url" rel="index"><span itemprop="name">fe</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>简介：想了解我们最新开发Vue技术栈的构建工具 <code>Gaea4.0</code> 吗？它拥有许多新的特性：<code>Webpack4</code>、<code>Babel7</code>、京东特色的 <code>Vue</code> 组件库 <code>NutUI2.0</code> 等等。</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们团队在最近两年慢慢从PC端转移到移动端，技术栈从 <code>JQuery</code>、<code>zepto</code> 等DOM操作转移到 <code>Vue</code>、<code>React</code> 等新的技术栈。曾经部门的构建工具 <code>JDF</code> 已经慢慢退出舞台，现在对于新的技术栈需要新的构建工具 <code>Butler</code> 和 <code>Gaea4.0</code>。本文主要介绍<code>Gaea4.0</code>，它依然需要秉承 <code>JDF</code> 的定位，力求解决部门团队减少配置开发环境的工作量，做到开箱即用。又可以做到自定义配置，方便开发者根据实际情况插件式的配置开发环境。包含从开发、调试、上线整个流程的功能。下面将全面的介绍一下 <code>Gaea4.0</code> 构建工具。</p><p><code>Gaea4.0</code> 从最初的一个 <code>Webpack</code> 的模版，慢慢演变成一个Vue2.0技术栈的工程具备了以下几个功能：</p><ul><li>cli脚手架工具</li><li>Webpack模版</li><li>核心组件库 <code>NutUI2.0</code></li><li>辅助功能</li></ul><h2 id="cli脚手架工具"><a href="#cli脚手架工具" class="headerlink" title="cli脚手架工具"></a>cli脚手架工具</h2><p>从 <code>Vue-cli</code> 的整体设计可以学习到cli构建工具和模版相分离的设计思路，我们可以通过命令行，选择匹配不同的模版下载，用于不同的开发需求。分开维护的好处是，模版的变动更新，并不需要用户端重新发布和安装cli构建工具，并且也保证了一致性，当我们有发现模版bug，修复后，也能及时同步远端。<br><img src="http://img13.360buyimg.com/uba/jfs/t1/24305/28/4664/11020/5c346336Eb8e72d19/d7c48e8140334392.png" width="640px"><br>如上图所示，将不同场景的可直接运行的webpack模版代码放在 <code>git</code> 上维护，通过 <code>nodejs</code> 命令行交互方式获取用户配置项目信息和插件信息，通过 <code>metadata</code> 模版渲染方式，将模版和自定义部门相结合，最后输出用户需要的模版工程代码。</p><h3 id="先了解一下需要的第三库："><a href="#先了解一下需要的第三库：" class="headerlink" title="先了解一下需要的第三库："></a>先了解一下需要的第三库：</h3><p>commander.js，可以自动解析命令参数，用于处理用户输入的命令。<br>download-git-repo，下载并提取git仓库，用于下载模版。<br>Inquirer.js，通用的命令行用户界面集合，用于和用户进行交互。<br>ora，下载过程loading动画效果。<br>chalk，可以给终端字体颜色。<br>log-symbols，在终端上显示对勾或者叉图案。<br>latest-version，获取库最新版本号。<br>metalsmith，静态网站生成器，批量处理模版。<br>handlebars.js，模版引擎，将用户提交的动态信息填充到文件中。</p><h3 id="一点一滴搭建cli脚手架"><a href="#一点一滴搭建cli脚手架" class="headerlink" title="一点一滴搭建cli脚手架"></a>一点一滴搭建cli脚手架</h3><p>第一步：通过 <code>commander.js</code> 实现命令init项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">program.usage(<span class="string">'&lt;name&gt;'</span>).parse(process.argv)</span><br><span class="line"><span class="built_in">let</span> projectName = program.args[0]</span><br><span class="line"><span class="keyword">if</span>(!projectName)&#123;</span><br><span class="line">    program.help()</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gaea init projectName</code> 也许你觉得命令太长，想短一点，也可以支持 <code>g2 init projectName</code>。因为 <code>commander</code> 支持<code>git</code> 风格的子命令处理，格式是 <code>[command]-[subcommand]</code>，例如：</p><ul><li>gaea init =&gt; gaea-init</li><li>g2 init =&gt; g2-init</li></ul><p>所以我在原先的 <code>gaea-init.js</code> 文件基础上新增加了一个 <code>g2-init.js</code> 文件。</p><p>第二步：通过 <code>Inquirer.js</code> 命令行问答交互方式配置项目信息和插件信息，在 <code>Gaea</code> 中，除了一些基本信息外，还需要选择需要提前打包的第三库，以及一些开发中常用的功能。这里设置的参数名字也是后面模版生成时候占位的名字。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">const answer = await  new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">       <span class="keyword">if</span>(projectRoot != <span class="string">'.'</span>)&#123;</span><br><span class="line">           fs.mkdirSync(projectRoot);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">return</span> resolve( inquirer.prompt([</span><br><span class="line">           &#123;</span><br><span class="line">               name:<span class="string">'projectName'</span>,</span><br><span class="line">               message:<span class="string">'项目名称'</span>,</span><br><span class="line">               default:<span class="string">'gaea-init'</span></span><br><span class="line">           &#125;,</span><br><span class="line">           &#123;</span><br><span class="line">               name:<span class="string">'projectVersion'</span>,</span><br><span class="line">               message:<span class="string">'项目版本号'</span>,</span><br><span class="line">               default:<span class="string">'1.0.0'</span></span><br><span class="line">           &#125;,</span><br><span class="line">           &#123;	</span><br><span class="line">               name:<span class="string">'bucket'</span>,</span><br><span class="line">               <span class="built_in">type</span>:<span class="string">'checkbox'</span>,</span><br><span class="line">               message:<span class="string">'第三方依赖库(多选)'</span>,</span><br><span class="line">               validate:(bucketstr)=&gt;&#123;</span><br><span class="line">                   <span class="built_in">return</span> new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">                       <span class="keyword">if</span>(bucketstr.indexOf(<span class="string">'vue'</span>) === -1)&#123;</span><br><span class="line">                           reject(<span class="string">'vue 必选！'</span>);</span><br><span class="line">                       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                           resolve(<span class="literal">true</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;)</span><br><span class="line">               &#125;,</span><br><span class="line">               choices:</span><br><span class="line">               [&#123;</span><br><span class="line">                   name:<span class="string">'vue'</span>,</span><br><span class="line">                   checked:<span class="literal">true</span></span><br><span class="line">               &#125;,&#123;</span><br><span class="line">                   name:<span class="string">'vue-router'</span>,</span><br><span class="line">                   checked:<span class="literal">true</span></span><br><span class="line">               &#125;]</span><br><span class="line">           &#125;,&#123;</span><br><span class="line">               name:<span class="string">'features'</span>,</span><br><span class="line">               <span class="built_in">type</span>:<span class="string">'checkbox'</span>,</span><br><span class="line">               message:<span class="string">'支持的功能选择'</span>,</span><br><span class="line">               choices:[</span><br><span class="line">                   &#123;</span><br><span class="line">                       name:<span class="string">'NutUI2'</span>,</span><br><span class="line">                       checked:<span class="literal">true</span>,</span><br><span class="line">                   &#125;,</span><br><span class="line">                   &#123;</span><br><span class="line">                       name:<span class="string">'Carefree'</span>,</span><br><span class="line">                       checked:<span class="literal">true</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   </span><br><span class="line">               ]</span><br><span class="line">           &#125;</span><br><span class="line">       ]))</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><p>第三步：通过 <code>download-git-repo</code> 去 <code>git</code> 库下载模版集合。这里的 <code>dev</code> 分支存储了<code>vue</code>、<code>vuex</code>、<code>skeleton</code>、<code>typescript</code>四套模版。这里是统一全部都下载下来，然后根据命令行交互的信息进行筛选和处理。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const download  = require(<span class="string">'download-git-repo'</span>);</span><br><span class="line">const ora       = require(<span class="string">'ora'</span>);</span><br><span class="line">const path      = require(<span class="string">'path'</span>);</span><br><span class="line">module.exports = <span class="keyword">function</span>(target)&#123;</span><br><span class="line">    target = path.join(target || <span class="string">'.'</span>,<span class="string">'.download-temp'</span>)</span><br><span class="line">    <span class="built_in">return</span> new Promise (<span class="keyword">function</span>(resolve,reject)&#123;</span><br><span class="line">        const url = <span class="string">'direct:https://github.com/jdf2e/Gaea4.git#dev'</span></span><br><span class="line">        const spinner = ora(<span class="string">'正在下载模版'</span>)</span><br><span class="line">        spinner.start()</span><br><span class="line">        download(url,target,&#123;<span class="built_in">clone</span>:<span class="literal">true</span>&#125;,(err)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                spinner.fail()</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                spinner.succeed()</span><br><span class="line">                resolve(target)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第四步：<code>generator.js</code> 处理所有信息输出最终工程模版。传入 <code>metadata</code> 数据、下载的临时文件夹地址、最终模版生成的目录地址。通过 <code>metalsmith</code> 和 <code>handlebars</code> 处理模版，删除不需要的文件，填入模版动态数据。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const res = await generator(context.metadata,context.downloadTemp,dest);</span><br></pre></td></tr></table></figure><p>因为download的模版是一个集合，那么我们怎么根据 <code>Inquirer.js</code> 选择的工程信息匹配到对应的模版，这里还需要一个 <code>template.ignore</code> 文件。该文件配置了文件查找的匹配规则，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="comment">#if Skeleton&#125;&#125;</span></span><br><span class="line">skeleton/**</span><br><span class="line">skeleton/.*</span><br><span class="line">&#123;&#123;<span class="keyword">else</span> <span class="keyword">if</span> TypeScript&#125;&#125;</span><br><span class="line">ts/**</span><br><span class="line">ts/.*</span><br><span class="line">&#123;&#123;<span class="keyword">else</span> <span class="keyword">if</span> vuex&#125;&#125;</span><br><span class="line">vuex/**</span><br><span class="line">vuex/.*</span><br><span class="line">&#123;&#123;<span class="keyword">else</span> <span class="keyword">if</span> vue&#125;&#125;</span><br><span class="line">vue/**</span><br><span class="line">vue/.*</span><br><span class="line">&#123;&#123;/<span class="keyword">if</span>&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">return</span> new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">        const metalsmith = Metalsmith(process.cwd()).metadata(metadata).clean(<span class="literal">false</span>).<span class="built_in">source</span>(src).destination(dest);</span><br><span class="line">        //判断是否存在ignore文件</span><br><span class="line">        const ignoreFile = path.join(src,<span class="string">'templates.ignore'</span>);</span><br><span class="line">        <span class="keyword">if</span>(fs.existsSync(ignoreFile))&#123;</span><br><span class="line">            metalsmith.use((files,metalsmith,<span class="keyword">done</span>) =&gt;&#123;</span><br><span class="line">                const meta = metalsmith.metadata();</span><br><span class="line">                const ignores = Handlebars.compile(fs.readFileSync(ignoreFile).toString())(meta)</span><br><span class="line">                .split(<span class="string">'\n'</span>).filter(item=&gt;!!item.length)</span><br><span class="line">               //删除文件</span><br><span class="line">                <span class="keyword">done</span>()</span><br><span class="line">            &#125;).build(err=&gt;&#123;</span><br><span class="line">                metalsmith.use((files, metalsmith,<span class="keyword">done</span>) =&gt; &#123;</span><br><span class="line">                    const meta = metalsmith.metadata()</span><br><span class="line">                    Object.keys(files).forEach(fileName =&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span>(fileName.indexOf(<span class="string">'/src/'</span>) == -1)&#123; //忽略业务代码</span><br><span class="line">                            <span class="built_in">let</span> t = files[fileName].contents.toString()</span><br><span class="line">                            files[fileName].contents = new Buffer(Handlebars.compile(t)(meta))</span><br><span class="line">                        &#125;</span><br><span class="line">                       </span><br><span class="line">                    &#125;)</span><br><span class="line">                    <span class="keyword">done</span>();</span><br><span class="line">                &#125;).build(err =&gt; &#123;</span><br><span class="line">                    //移动文件</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p>第五步：通过 <code>ora</code> 、 <code>chalk</code> 和 <code>log-symbols</code> 美化脚手架<br>在下载模版时候，或者获取库版本时候，都会比较慢，如果终端没有给出任何信息似乎体验上会比较差，在下载模版的时候，增加了 <code>ora</code> 代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const spinner = ora(<span class="string">'正在下载模版'</span>)</span><br><span class="line">spinner.start()</span><br><span class="line">download(url,target,&#123;<span class="built_in">clone</span>:<span class="literal">true</span>&#125;,(err)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                spinner.fail()</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                spinner.succeed()</span><br><span class="line">                resolve(target)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>在最终工程模版生成的时候，可以给出字体颜色表示是否成功，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">console.log(logSymbols.success,chalk.green(<span class="string">'创建成功:)'</span>));</span><br><span class="line">console.log(logSymbols.error,chalk.red(`创建失败：<span class="variable">$&#123;err.message&#125;</span>`));</span><br></pre></td></tr></table></figure><p>完成上面5个步骤之后，我们看一下脚手架的实际效果：<br><img src="https://img12.360buyimg.com/uba/jfs/t1/24654/7/4795/1474509/5c3581bdE7d3955e1/033abed0cbe735b3.gif" width="640px"></p><h2 id="Webpack-模版"><a href="#Webpack-模版" class="headerlink" title="Webpack 模版"></a>Webpack 模版</h2><p>有了命令行工具，我们还需要 <code>Webpack</code> 工程模版，在最开始的时候 <code>Gaea</code> 只是一个 <code>Vue</code> 单页面的 <code>Webpack</code> 的模版。用于项目的开发、打包编译、上传。那 <code>Gaea4.0</code> 给我们带来哪些新变化 <code>Webpack4.0</code> 和 <code>Babel7</code></p><h3 id="Webpack4-0"><a href="#Webpack4-0" class="headerlink" title="Webpack4.0"></a>Webpack4.0</h3><p>趁着这次的工具的开发，直接将Webpack从 <code>3.x</code> 升级到了 <code>4.x</code>。简单罗列一下升级中需要注意的点：</p><ol><li>推荐使用 <code>node</code> 版本 &gt;=8.9.0，在使用时候可以有更好的体验</li><li>借鉴了 <code>parcel</code> 零配置构建思想，新增了模式配置：<code>mode</code>，可选值是 <code>production</code> 和 <code>development</code>。<code>mode</code> 不可缺省，需要二选一：</li></ol><h4 id="production-模式："><a href="#production-模式：" class="headerlink" title="production 模式："></a>production 模式：</h4><p>默认提供所有可能的优化，如代码压缩/作用域提升/ <code>tree-shaking</code> 等<br>不支持watching<br><code>process.env.NODE_ENV</code> 的值不需要再定义，默认是 <code>production</code></p><h4 id="development-模式："><a href="#development-模式：" class="headerlink" title="development 模式："></a>development 模式：</h4><p>主要优化了增量构建速度和开发体验<br><code>process.env.NODE_ENV</code> 的值不需要再定义，默认是 <code>development</code></p><p>在 <code>Webpack</code> 配置文件中，我们往往需要拿到当前的 <code>npm</code> 命令执行的模式，可以如下拿到参数值：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dev"</span>: <span class="string">" webpack-dev-server --mode development   -d --open --hide-modules --progress"</span>,</span><br><span class="line"> <span class="string">"build"</span>: <span class="string">"webpack --mode production --hide-modules --progress"</span>,</span><br><span class="line"> <span class="string">"upload"</span>: <span class="string">"webpack --mode production --env.upload --hide-modules --progress"</span>,</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports = (env,argv)=&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(argv.mode === <span class="string">'production'</span>)&#123;</span><br><span class="line">       //判断是否是生产环境</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(env &amp;&amp; env.upload)&#123;</span><br><span class="line">      //判断是否是编译上传</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>Webpack</code> 打包优化方面，对于第三方的依赖库，例如<code>vue</code>、<code>vuex</code>、<code>vue-router</code>等我们会单独提前预先 <code>Dllplugin</code> 打包 <code>vendor</code> 文件。那么可以对比一下构建 <code>vendor</code> 的大小和和时间。</p><p><code>Webpack3</code> 效果如下：<br><img src="https://img30.360buyimg.com/uba/jfs/t1/8505/12/12511/97151/5c35c4cbE495bbc04/36f2287411aa1ab7.jpg" width="640px"></p><p><code>Webpack4</code> 效果如下：<br><img src="https://img12.360buyimg.com/uba/jfs/t1/29927/27/4862/82546/5c35bab1Ecd405c5c/58b9db21ba4f3c2f.jpg" width="640px"></p><p>从打包上看，对于Vue第三方库全家桶，<code>4.x</code> 比 <code>3.x</code> 减少了14%。时间也减少了8%。<code>4.x</code>在打包编译构建速度上做了很大优化，这里就不展开了，对于整体项目构建提升效果是很明显的。</p><ol start="3"><li><code>MiniCssExtractPlugin</code> 替代 <code>ExtractTextWebpackPlugin</code>，如果还想用 <code>ExtractTextWebpackPlugin</code>，可以下载 <code>next</code> 版本。</li></ol><h3 id="Babel-7"><a href="#Babel-7" class="headerlink" title="Babel 7"></a>Babel 7</h3><p>曾经在做移动端页面的时候，为了使用 <code>es6</code> 或者 <code>es7</code> 语法，又要兼容比较低版本的 <code>android</code> 或者 <code>ios</code> 等使用场景，我们只能加载完整版本80kb左右的 <code>polyfill</code> 文件。<code>Babel7</code> 真正做到按目标浏览器兼容的浏览器按需加载 <code>polyfill文件</code>。如何做到呢？我们看一下 <code>.babelrc</code> 文件。首先配置 <code>babel preset env</code>：将 <code>ES6</code> 的代码转成 <code>ES5</code> (注意： <code>babel-preset-es2015</code> 已经被废弃了)。设置目标浏览器的范围，设置 <code>useBuiltIns:usage</code>。<code>usage</code><br>是新特性，可以只打包业务代码中需要转换的 <code>polyfill</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"presets"</span>: [</span><br><span class="line">        [<span class="string">"@babel/preset-env"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">           <span class="string">"modules"</span>:<span class="literal">false</span>,</span><br><span class="line">           <span class="string">"targets"</span>:&#123;</span><br><span class="line">            <span class="string">"browsers"</span>: [<span class="string">"&gt; 1%"</span>, <span class="string">"last 2 versions"</span>, <span class="string">"not ie &lt;= 8"</span>,<span class="string">"Android &gt;= 4"</span>,<span class="string">"iOS &gt;= 8"</span>]</span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="string">"useBuiltIns"</span>:<span class="string">"usage"</span></span><br><span class="line">            </span><br><span class="line">        &#125;]</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"plugins"</span>: [</span><br><span class="line">            [<span class="string">"@nutui/babel-plugin-separate-import"</span>,&#123;<span class="string">"style"</span>:<span class="string">"css"</span>&#125;],</span><br><span class="line">            <span class="string">"@babel/plugin-syntax-dynamic-import"</span></span><br><span class="line">            </span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试源码如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">let</span> m = [3,4];</span><br><span class="line">console.log([...this.spread,...m]);</span><br><span class="line"><span class="built_in">let</span> obj = Object.assign(&#123;&#125;,this.obj); </span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">let</span> a of m)&#123;</span><br><span class="line">      console.log(a);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>使用 <code>useBuiltIns:usage</code> 打包：<br><img src="https://img30.360buyimg.com/uba/jfs/t1/19168/5/4868/157044/5c35d0c8E3ceb38fe/a5a5c35ef2576296.jpg" width="640px"><br>这结果是不是很让人兴奋。</p><h3 id="模版集合"><a href="#模版集合" class="headerlink" title="模版集合"></a>模版集合</h3><p>当我们搭建完 <code>Webpack4</code> 的工程模版后，为了进一步降低用户的使用的难度，从项目的实践中总结和抽取比较完整的模版方案：<code>Vue</code>、<code>Vuex</code>、<code>TypeScript</code>、<code>Skeleton</code> 四套模版。目前暂时支持这些，后续考虑加入活动页模版、PC端模版等<br><img src="https://img20.360buyimg.com/uba/jfs/t1/17890/31/4915/16782/5c35de96E56cfe0e0/de7b34e8f914c3d7.png" width="640px"></p><h2 id="核心组件库NutUI2-0"><a href="#核心组件库NutUI2-0" class="headerlink" title="核心组件库NutUI2.0"></a>核心组件库NutUI2.0</h2><p>对于一个 <code>Vue</code> 技术栈来说，少不了实用的组件库。现在业界有很多优秀的组件 <code>iView</code>、<code>element</code> 等。不过我们团队做的<code>NutUI2.0 Vue</code> 组件库也同样优秀，不仅服务于部门内部，也服务于公司的其他部门团队。目前有30+数量的组件，大多数来源于京东app、京东me等使用场景的实际项目积累和沉淀。基于京东APP 7.0 视觉规范。<code>Gaea4.0</code> 是默认安装 <code>@nutui/nutui</code> 组件库 <code>npm</code> 包和 <code>@nutui/babel-plugin-seperate-import</code> 按需加载插件 <code>npm</code> 包。在项目中，推荐使用按需加载方式调用组件代码，减小打包体积。同时支持组件内挂载，也支持全局挂载。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &#123; DatePicker,Button,Rating &#125; from <span class="string">'@nutui/nutui'</span>;</span><br><span class="line">...</span><br><span class="line"><span class="built_in">export</span> default &#123;</span><br><span class="line">    <span class="function"><span class="title">data</span></span>()&#123;</span><br><span class="line">        <span class="built_in">return</span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    components: &#123;</span><br><span class="line">        <span class="string">'nut-datepicker'</span>:DatePicker,</span><br><span class="line">        <span class="string">'nut-button'</span>:Button,</span><br><span class="line">        <span class="string">'nut-rating'</span>:Rating</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &#123; Cell,Dialog &#125; from <span class="string">'@nutui/nutui'</span>;</span><br><span class="line">Vue.use(Cell);</span><br><span class="line">Vue.use(Dialog);</span><br></pre></td></tr></table></figure><h2 id="辅助功能"><a href="#辅助功能" class="headerlink" title="辅助功能"></a>辅助功能</h2><p>我们团队开发了许多提高效率插件和功能，<code>Gaea4.0</code> 都进行有效整合，方便用户使用。</p><ul><li>一键上传</li><li>carefree：webpack插件，开发阶段自动编译上传测试服务器，提供二维码真机调试</li><li>smock：webpack插件，开发阶段基于Swagger的自动化mock假数据</li><li>skeleon：利用骨架屏vue组件和vue-server-reander 手写注入骨架屏html和css</li></ul><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>最后通过cli脚手架工具、<code>Webpack</code> 模版、核心组件库 <code>NutUI2.0</code> 和辅助功能四个方面的讲解，大家对 <code>Gaea4.0</code> 有所了解吧，它力求做一个简易好用的 <code>Vue</code> 技术栈构建工具。整体的设计就如下图：<br><img src="https://img10.360buyimg.com/uba/jfs/t1/15571/28/4772/23937/5c35e95fEd334d898/f61c2a58eca88a90.png" width="640px"><br><code>Gaea4.0</code> 学习了很多业界前辈分享的经验，结合项目中的实践的经验，最后得出的一点小成果，希望能给大家一点启发和帮助。<br>欢迎使用和关注<br>github 地址：<a href="https://github.com/jdf2e/Gaea4/" target="_blank" rel="noopener">https://github.com/jdf2e/Gaea4/</a><br>npm 地址：<a href="https://www.npmjs.com/package/gaea-cli" target="_blank" rel="noopener">https://www.npmjs.com/package/gaea-cli</a><br>NutUI2.0 地址：<a href="http://nutui.jd.com/" target="_blank" rel="noopener">http://nutui.jd.com/</a></p><h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><p>Butler:<a href="http://butler.jd.com" target="_blank" rel="noopener">http://butler.jd.com</a><br>iView: <a href="https://www.iviewui.com/" target="_blank" rel="noopener">https://www.iviewui.com/</a><br>element: <a href="http://element-cn.eleme.io" target="_blank" rel="noopener">http://element-cn.eleme.io</a><br>carefree: <a href="http://carefree.jd.com" target="_blank" rel="noopener">http://carefree.jd.com</a><br>smock: <a href="http://smock.jd.com" target="_blank" rel="noopener">http://smock.jd.com</a><br>commander.js: <a href="https://github.com/tj/commander.js/" target="_blank" rel="noopener">https://github.com/tj/commander.js/</a><br>download-git-repo: <a href="https://github.com/flipxfx/download-git-repo" target="_blank" rel="noopener">https://github.com/flipxfx/download-git-repo</a><br>Inquirer.js: <a href="https://github.com/SBoudrias/Inquirer.js/" target="_blank" rel="noopener">https://github.com/SBoudrias/Inquirer.js/</a><br>ora: <a href="https://github.com/sindresorhus/ora" target="_blank" rel="noopener">https://github.com/sindresorhus/ora</a><br>chalk: <a href="https://github.com/chalk/chalk" target="_blank" rel="noopener">https://github.com/chalk/chalk</a><br>log-symbols: <a href="https://github.com/sindresorhus/log-symbols" target="_blank" rel="noopener">https://github.com/sindresorhus/log-symbols</a><br>latest-version: <a href="https://github.com/sindresorhus/latest-version" target="_blank" rel="noopener">https://github.com/sindresorhus/latest-version</a><br>metalsmith: <a href="https://github.com/segmentio/metalsmith" target="_blank" rel="noopener">https://github.com/segmentio/metalsmith</a><br>handlebars.js: <a href="https://github.com/wycats/handlebars.js/" target="_blank" rel="noopener">https://github.com/wycats/handlebars.js/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/hero.me/images/avatar.jpg" alt="小南"><p class="site-author-name" itemprop="name">小南</p><p class="site-description motion-element" itemprop="description">前端开发文艺工作者</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/hero.me/categories/archives/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"> <span class="site-state-item-count">6</span> <span class="site-state-item-name">标签</span></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wangnan41" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">小南</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> 访问人数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i> 访问次数<span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/hero.me/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/hero.me/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/hero.me/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/hero.me/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/hero.me/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/hero.me/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/hero.me/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/hero.me/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/hero.me/js/src/bootstrap.js?v=5.1.4"></script></body></html>